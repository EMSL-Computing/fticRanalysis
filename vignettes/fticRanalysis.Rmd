---
title: "Introduction to fticRanalysis"
author: Lisa Bramer, Amanda White, Allison Thompson, Lee Ann McCue
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 1
    number_sections: true
  pkgdown:
    toc: true
    toc_depth: 1
##    toc_float:
##      collapsed: false
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Introduction to fticRanalysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 8, 
  fig.height = 6
)
```

## Introduction

### FTICR Analysis
* Fourier-transform ion cyclotron resonance (FTICR) mass spectrometry is a type of mass spectrometery for determining the mass-to-charge ratio (m/z) of ions based on the cyclotron frequency of the ions in a fixed magnetic field.

* Chemical composition can be determined for a portion of the observed peaks/mass-to-charge ratios. 

* Data resulting from FTICR instrument runs can be interpreted as the area under a peak for each observed peak. These are comparable in magnitude within a sample but are not comparable across samples.

### fticRanalysis

The fticRanalysis package was designed to help with various steps of processing FTICR data, including:

* data formatting and manipulation  
* reproducible analysis pipeline  
* filtering data based on various properties  
* calculating meta information for each peak (e.g. NOSC)  
* data visualization and summary  
    * one sample  
    * multiple samples   
    * group comparisons  

### The Experiment

* Goal: assess differences in soil organic matter between multiple locations and crop types
* Measurement: 12T FTICR mass spectrometer
* Subset of full experiment data
* Locations: M, W
* Crop Flora: S, C

## Data loading

### Experimental data

We have found that most 'omics data generated by EMSL can be divided into three parts:

* **Expression Data** - observed data for each biomolecule (rows) and sample (columns)  
    * e.g. area under peaks for mass spec data  
    * e.g. spectral counts for each protein  
* **Sample Data** - data capturing relevant experimental factors (columns) for each sample (rows)  
    * e.g. samples and their sampling locations, treatment applied, etc.  
* **Biomolecule Data** - other characteristics or quantified values (columns) for each biomolecule (rows)  
    * e.g. peptide to protein mapping  


### Edata (Expression Data)
The edata object is a data frame with one row per peak and one column per sample. It must have one column that is a unique ID (e.g. Mass).

```{r }
library(fticRanalysis)
data("fticr12T_edata")
str(fticr12T_edata)
```

### Fdata (Sample Data)
The fdata object is a data frame with one row per sample with information about experimental conditions. It must have a column that matches the sample column names in edata.

```{r}
data("fticr12T_fdata")
str(fticr12T_fdata)
```

### Emeta (Biomolecule Data)
The emeta object is a data frame with one row per peak and columns containing other meta data such as molecular formula or elemental columns. It must have an ID column corresponding to the ID column in edata.

```{r }
data("fticr12T_emeta")
str(fticr12T_emeta)
```

### Constructing a peakIcrData object

```{r}
picr <- as.peakIcrData(fticr12T_edata, fticr12T_fdata, fticr12T_emeta, 
                       edata_cname="Mass", fdata_cname="SampleID", 
                       mass_cname="Mass", c_cname="C", h_cname="H", 
                       o_cname="O", n_cname="N", s_cname="S", 
                       p_cname="P", isotopic_cname = "C13", 
                       isotopic_notation = "1")
picr
```

### Other Parameters 

* data_scale - assumed to be 'abundance' or area under the peak. Other options include: log2, log10, log, presence/absence (0/1)  
* instrument_type - assumed to be 12T/15T; vizualization methods for 21T coming  
* extraction_cname - name of column in f_data specifying extraction (e.g. water)
* __must give elemental count columns or molecular formula__
* isotopic column is optional - isotopes are currently filtered out of the data
* data_scale - assumed to be 'abundance' or area under the peak. Other options include: log2, log10, log, presence/absence (0/1)  
* instrument_type - assumed to be 12T/15T; vizualization methods for 21T coming  
* extraction_cname - name of column in f_data specifying extraction (e.g. water)

### peakIcrDataObject 

The peakIcrData object contains three elements, named e_data, f_data, and e_meta:
```{r}
names(picr)
```

During object constructing, the molecular formula is calculated from the elemental columns:
```{r}
tail(picr$e_meta)
```

### Summary method

```{r}
summary(picr)
```

### Plot method

```{r message=FALSE}
plot(picr)
```

## Preprocessing


### Transforming abundance values

* When dealing with 'omics data quantitatively, we often log-transform to stabilize variances and reduce skew for downstream statistics.  

* It's common to treat FTICR data as presence/absence data

```{r}
picr <- edata_transform(picr, data_scale="log2")
```

Or replace 0s with NAs

```{r, eval = F}
edata_replace(picr, x = 0, y = NA)
```

### Plot transformed data

```{r}
plot(picr)
```

### Calculating meta-data values
NOSC, aromaticity, O:C and H:C ratios, etc. 

```{r}
picr <- compound_calcs(picr)
picr
```

### Assigning classes 

`bs1` - Kim, S., et al (2003). Analytical Chemistry.  
`bs2` - Bailey, V. et al (2017). Soil Biology and Biochemistry.  
`bs3` - Rivas-Ubach, A., et al (2018). Analytical chemistry. -- coming soon

```{r}
picr <- assign_class(picr, boundary_set = "bs1")
table(picr$e_meta$Class)
```

### Filtering

There are multiple types of filtering algorithms provided in `fticRanalysis`: 

* __Molecule filter__: filter rows of e_data to exclude rows observed in too few samples
* __Mass filter__: filter rows based on mass, e.g. to reflect observational sensitivity of the instrument
* __Formula filter__: filter rows based on whether they have a molecular formula
* __Emeta filter__: filter rows of e_data based on a quantity/column in e_meta

### Filtering example

```{r}
filter_obj <- mass_filter(picr)
plot(filter_obj, min_mass=200, max_mass=900)
```

### Filtering example continued

```{r}
summary(picr)
picr <- applyFilt(filter_obj, picr, min_mass = 200, 
                  max_mass = 900)
summary(picr)
```

### Other filter types

Other filtering options include number of molecule observations, formula presence or absence, or emeta columns.

```{r}
picr <- applyFilt(molecule_filter(picr), picr, min_num=2)
picr <- applyFilt(formula_filter(picr), picr)
picr <- applyFilt(emeta_filter(picr, "NOSC"), picr, min_val = 0.5)
summary(picr)
```

## Visualizations of one sample

### Subsetting to one sample

```{r}
one_sample <- subset(picr, samples="EM0011_sample")
summary(one_sample)
head(one_sample$e_data)
```

### Van Krevelen plot
A Van Krevelen plot shows H:C ratio vs O:C ratio for each peak observed in a sample
that has a mass formula (thus H:C and O:C are known). By default, the points are 
colored according to functional class.

### Van Krevelen plot example

```{r message=FALSE, warning=FALSE}
vanKrevelenPlot(one_sample, title="EM0011_sample")
```

### Customizing a Van Krevelen plot 

By default, this function colors by Van Krevelen class. However, we can also color the points according to other meta data columns in the `e_meta` object.

```{r}
vanKrevelenPlot(one_sample, colorCName="PtoC_ratio", 
                title="Color by P:C Ratio", legendTitle = "P:C Ratio")
```

### Density plot 

We can also plot the distributions of any (numeric) column of meta-data (i.e. column of `e_meta`). 

```{r}
densityPlot(one_sample, variable = "NOSC", plot_curve=TRUE, plot_hist=TRUE,
            title="NOSC Distribution for EM0011_sample")
```

### Histogram

It's also possible to plot just the histogram or just the density curve with this function with the `plot_hist` and `plot_curve` parameters.

```{r}
densityPlot(one_sample, variable = "kmass", 
            title="Kendrick Mass for EM0011_sample", plot_hist=TRUE, 
            plot_curve = FALSE, yaxis="count")
```

### Kendrick plot

A Kendrick plot shows Kendrick Defect vs Kendrick mass for each observed peak.

Ions of the same family have the same Kendrick mass defect and are positioned along a horizontal line on the plot. Kendrick plot is often used in conjunction with a Van Krevelen plot for evaluating elemental composition.

```{r}
kendrickPlot(one_sample, title="Kendrick Plot for EM0011_sample")
```

## Analysis of experimental groups

### Experiment goal

The goal of this experiment was to identify differences in soil organic matter between
sample locations and crop types.

In order to do that we need to compare experimental treatments (groups). 

### How to define groups

The `group_designation` method defines treatment groups based on the variable(s)
specified as main effects. 

```{r}
picr <- group_designation(picr, main_effects=c("Crop.Flora"))
getGroupDF(picr)
```

### Summarizing groups

The `summarizeGroups` function calculates group-level summaries per peak, such as the number or proportion of samples in which peak is observed. The resulting object's `e_data` element contains one column per group, per summary function.

```{r message=FALSE}
group_summary <- summarizeGroups(picr, summary_functions = 
                                   c("n_present", "prop_present"))
head(group_summary$e_data)
```

### Comparing distributions between two groups

```{r}

densityPlot(picr, samples=FALSE, groups=c("S","C"), variable="NOSC", 
            title="Comparison of NOSC Between Crop Types") 
```


### Constructing group comparison subsets

Create peakIcrData objects that each contain two groups to facilitate group comparisons

```{r}

byGroup <- divideByGroupComparisons(picr, 
                                comparisons = "all")[[1]]$value

crop_unique <- summarizeGroupComparisons(byGroup, 
            summary_functions="uniqueness_gtest", 
            summary_function_params=list(
                  uniqueness_gtest=list(pres_fn="nsamps", 
                          pres_thresh=2, pvalue_thresh=0.05)))

tail(crop_unique$e_data)
```

### Van Krevelen plot comparing groups

```{r}
vanKrevelenPlot(crop_unique, colorCName = "uniqueness_gtest")
```

### Integration with biological databases

* Functionality to map peaks to compounds, reactions, and modules
* Vignette coming soon!
